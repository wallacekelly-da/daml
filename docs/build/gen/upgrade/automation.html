<!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automating the Upgrade Process &mdash; Daml SDK __VERSION__ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
  
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  <script type="text/javascript" src="../_static/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/copybutton.js"></script>
  
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Authorization" href="../app-dev/authorization.html" />
  <link rel="prev" title="Upgrading Daml applications" href="upgrade.html" /> 

  
  <link rel="icon" type="image/svg+xml"  href="../_static/images/daml-logo-mark-light.svg">
  <link rel="alternate icon" href="../_static/images/daml-favicon-1.ico">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MSWJMNX');</script>
  <!-- End Google Tag Manager -->

  
  <!-- Mopinion Pastea.se  start --><script type="text/javascript">(function(){var id="4s6vwov7ad6qyxhq8iwbyhocrsn2nm36k25";var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src","//deploy.mopinion.com/js/pastease.js");js.async=true;document.getElementsByTagName("head")[0].appendChild(js);var t=setInterval(function(){try{new Pastease.load(id);clearInterval(t)}catch(e){}},50)})();</script><!-- Mopinion Pastea.se end -->
</head>

<body class="wy-body-for-nav">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MSWJMNX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-nav-side-shadow"></div>
      <div class="wy-side-scroll">

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
          
          
          
          
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Daml Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installing the SDK</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/path-variables.html">Setting JAVA_HOME and PATH variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/manual-download.html">Manually installing the SDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Building Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/app-architecture.html">App Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-feature.html">Your First Feature</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.daml.com/cheat-sheet">Cheat Sheet</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../daml/intro/0_Intro.html">An introduction to Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/1_Token.html">1 Basic contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/2_DamlScript.html">2 Testing templates using Daml Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/3_Data.html">3 Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/4_Transformations.html">4 Transforming data using choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/5_Restrictions.html">5 Adding constraints to a contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/6_Parties.html">6 Parties and authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/7_Composing.html">7 Composing choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/8_Exceptions.html">8 Exception Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/9_Dependencies.html">9 Working with Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/10_Functional101.html">10 Functional Programming 101</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/11_StdLib.html">11 Intro to the Daml Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/12_Testing.html">12 Testing Daml Contracts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/reference/index.html">Language reference docs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/structure.html">Overview: template structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/templates.html">Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/choices.html">Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/updates.html">Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/data-types.html">Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/working-with.html">Built-in functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/expressions.html">Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/scenarios.html">Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/file-structure.html">File structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/packages.html">Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/contract-keys.html">Contract keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/patterns.html">Good design patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/initaccept.html">Initiate and Accept</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/multiparty-agreement.html">Multiple party agreement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/delegation.html">Delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/locking.html">Locking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-archiving.html">Locking by archiving</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-state.html">Locking by state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-safekeeping.html">Locking by safekeeping</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/legends.html">Diagram legends</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Building applications</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../app-dev/app-arch.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/bindings-ts/index.html">JavaScript Client Libraries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml2js.html">JavaScript Code Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-react.html">&#64;daml/react</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-ledger.html">&#64;daml/ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-types.html">&#64;daml/types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/testing.html">Testing Your Web App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../json-api/index.html">HTTP JSON API Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../json-api/lf-value-specification.html">Daml-LF JSON Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/search-query-language.html">Query language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/production-setup.html">Production Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-script/index.html">Daml Script</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-repl/index.html">Daml REPL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Upgrading and Extending Daml applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="extend.html">Extending Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">Upgrading Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Automating the Upgrade Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/authorization.html">Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/ledger-api.html">The Ledger API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/services.html">The Ledger API services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/index.html">gRPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/daml-to-ledger-api.html">How Daml types are translated to protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/daml-lf-translation.html">How Daml types are translated to Daml-LF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-java/index.html">Java bindings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/codegen.html">Generate Java code from Daml</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/example.html">Ping Pong Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/quickstart.html">Iou Quickstart Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-scala/index.html">Scala bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-js.html">Node.js bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-x-lang/index.html">Creating your own bindings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../triggers/index.html">Daml Triggers - Off-Ledger Automation in Daml</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/trigger-service/index.html">Trigger Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/auth0_example.html">Auth0 Example Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/auth-middleware/index.html">Auth Middleware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/auth-middleware/oauth2.html">OAuth 2.0 Auth Middleware</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../error-codes/self-service/index.html">Self-Service Error Codes (Experimental)</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../error-codes/self-service/index.html#self-service-error-codes-migration-guide">Self-Service Error Codes Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploying to Daml ledgers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploy/index.html">Overview of Daml ledgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/generic_ledger.html">Deploying to a generic Daml ledger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/ledger-topologies.html">Daml Ledger Topologies</a></li>
</ul>
<p class="caption"><span class="caption-text">Operating Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/index.html">Daml Participant pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/connect/index.html">Operating Daml Connect</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/helm.html">Connect Helm Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/auth0.html">Setting Up Auth0</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Developer Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/assistant.html">Daml Assistant (<code class="docutils literal notranslate"><span class="pre">daml</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/daml-studio.html">Daml Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sandbox.html">Daml Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/navigator/index.html">Navigator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/codegen.html">Daml codegen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler.html">Daml Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">Background concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/glossary.html">Glossary of concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/ledger-model/index.html">Daml Ledger Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-integrity.html">Integrity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-daml.html">Daml: Defining Contract Models Compactly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/identity-and-package-management.html">Identity and Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/time.html">Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/local-ledger.html">Causality and Local Ledgers</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://daml.com/examples">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Early Access Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/extractor.html">Extractor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/export/index.html">Ledger Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml-integration-kit/index.html">Daml Integration Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/ledger-api-test-tool/index.html">Ledger API Test Tool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/visual.html">Visualizing Daml Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/interoperability.html">Ledger Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/non-repudiation.html">Non-repudiation</a></li>
</ul>
<p class="caption"><span class="caption-text">Daml Ecosystem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support/overview.html">Daml Ecosystem Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/status-definitions.html">Status Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../support/component-statuses.html">Feature and Component Statuses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../support/releases.html">Releases and Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/compatibility.html">Portability, Compatibility, and Support Durations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/support.html">Getting Help</a></li>
</ul>

          
          
          
          <div class="pdf-download"><a href="../_downloads/DigitalAssetSDK.pdf" download>Download as PDF</a></div>
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <div class="topbar fixed">
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
          <i data-toggle="wy-nav-top" class="wy-nav-top-toggle"></i>
          
        </nav>
        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="navbar">
    <h1><img src="../_static/images/DAML_Logo_Blue.svg"></h1>
    <div class="navbar-menu">
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.daml.com/" role="menuitem" class="da-menu-link">Developers</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/products" role="menuitem" class="da-menu-link">Products</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com" role="menuitem" class="da-menu-link">Company</a>
        </div>
    </div>
</div>

        <div class="version ">
          <span class="hide-mobile">Version&nbsp;</span><span class="version_switcher_placeholder"></span>
          
        </div>


        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="search-inline">
    <div id="rtd-search-inline-form" class="wy-form">
        <input type="text" class="search-inline-input" placeholder="Search" name="q">
        <img src="../_static/images/Search.svg" class="search-inline-img"/>
    </div>
    <div class="search-alert">
        Please enter at least 3 letters.
    </div>
    <div id="search-inline-results" class="search-inline-results">
        
    </div>
</div>
          <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="content-menu collapsed">
    <span class="content-menu-title">In This Section</span>
    <span class="content-menu-expand"></span>
    <div class="content-menu-wrapper">
        
        <!-- Local TOC -->
        <div class="content-menu-toc"><ul>
<li><a class="reference internal" href="#">Automating the Upgrade Process</a><ul>
<li><a class="reference internal" href="#structuring-the-upgrade">Structuring the Upgrade</a></li>
<li><a class="reference internal" href="#implementation-of-the-daml-script">Implementation of the Daml Script</a></li>
<li><a class="reference internal" href="#implementation-of-the-daml-trigger">Implementation of the Daml Trigger</a></li>
<li><a class="reference internal" href="#deploying-and-executing-the-upgrade">Deploying and Executing the Upgrade</a></li>
</ul>
</li>
</ul>
</div>
        
    </div>
</div>
        

      </div>
      <div class="wy-nav-content">
        
        <div class="rst-content">
          
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
                
  <div class="section" id="automating-the-upgrade-process">
<span id="upgrade-automation"></span><h1>Automating the Upgrade Process<a class="headerlink" href="#automating-the-upgrade-process" title="Permalink to this headline">¶</a></h1>
<p>In this section, we are going to automate the upgrade of our carbon certificate
process using <a class="reference internal" href="../daml-script/index.html"><span class="doc">Daml Script</span></a> and
<a class="reference internal" href="../triggers/index.html"><span class="doc">Daml Triggers</span></a>. Note that automation for upgrades is
specific to an individual application, just like the upgrade models.
Nevertheless, we have found that the pattern shown here
occurs frequently.</p>
<div class="section" id="structuring-the-upgrade">
<h2>Structuring the Upgrade<a class="headerlink" href="#structuring-the-upgrade" title="Permalink to this headline">¶</a></h2>
<p>There are three kinds of actions performed during the upgrade:</p>
<ol class="arabic simple">
<li>Alice creates <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> contracts. We assume here,
that Alice wants to upgrade all <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts she has
issued. Since the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> proposal is specific to
each owner, Alice has to create one <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> per
owner. There can be potentially many owners but this step only has
to be performed once assuming Alice will not issue more <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code>
contracts after this point.</li>
<li>Bob and other owners accept the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code>. To keep
this example simple, we assume that there are only carbon certificates issued by
Alice. Therefore, each owner has to accept at most one proposal.</li>
<li>As owners accept upgrade proposals, Alice has to upgrade each
certificate. This means that she has to execute the upgrade choice once
for each certificate. Owners will not all accept the upgrade at the same
time and some might never accept it. Therefore, this should be a
long-running process that upgrades all carbon certificates of a given owner as
soon as they accept the upgrade.</li>
</ol>
<p>Given those constraints, we are going to use the following tools for
the upgrade:</p>
<ol class="arabic simple">
<li>A Daml script that will be executed once by Alice and creates an
<code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> contract for each owner.</li>
<li>Navigator to accept the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> as Bob. While we
could also use a Daml script to accept the proposal, this step will
often be exposed as part of a web UI so doing it interactively in
Navigator resembles that workflow more closely.</li>
<li>A long-running Daml trigger that upgrades all <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts
for which there is a corresponding <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertAgreement</span></code>.</li>
</ol>
</div>
<div class="section" id="implementation-of-the-daml-script">
<h2>Implementation of the Daml Script<a class="headerlink" href="#implementation-of-the-daml-script" title="Permalink to this headline">¶</a></h2>
<p>In our Daml Script, we are first going to query the ACS (Active Contract Set) to find all
<code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts issued by us. Next, we are going to extract the
owner of each of those contracts and remove any duplicates coming from
multiple certificates issued to the same owner. Finally, we iterate over the
owners and create an <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertAgreement</span></code> contract for each owner.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">initiateUpgrade</span> <span class="kt">:</span> <span class="kt">Party</span> <span class="ow">-&gt;</span> <span class="kt">Script</span> <span class="nb">()</span>
<span class="nf">initiateUpgrade</span> <span class="n">issuer</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">certs</span> <span class="ow">&lt;-</span> <span class="n">query</span> <span class="o">@</span><span class="kt">CarbonCert</span> <span class="n">issuer</span>
  <span class="kr">let</span> <span class="n">myCerts</span> <span class="ow">=</span> <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">_cid</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">issuer</span> <span class="o">==</span> <span class="n">issuer</span><span class="p">)</span> <span class="n">certs</span>
  <span class="kr">let</span> <span class="n">owners</span> <span class="ow">=</span> <span class="n">dedup</span> <span class="o">$</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">_cid</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span> <span class="n">myCerts</span>
  <span class="n">forA_</span> <span class="n">owners</span> <span class="o">$</span> <span class="nf">\</span><span class="n">owner</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
    <span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Creating upgrade proposal for: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">owner</span><span class="p">)</span>
    <span class="n">submit</span> <span class="n">issuer</span> <span class="o">$</span> <span class="n">createCmd</span> <span class="p">(</span><span class="kt">UpgradeCarbonCertProposal</span> <span class="n">issuer</span> <span class="n">owner</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation-of-the-daml-trigger">
<h2>Implementation of the Daml Trigger<a class="headerlink" href="#implementation-of-the-daml-trigger" title="Permalink to this headline">¶</a></h2>
<p>Our trigger does not need any custom user state and no heartbeat so
the only interesting field in its definition is the rule.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">upgradeTrigger</span> <span class="kt">:</span> <span class="kt">Trigger</span> <span class="nb">()</span>
<span class="nf">upgradeTrigger</span> <span class="ow">=</span> <span class="kt">Trigger</span> <span class="kr">with</span>
  <span class="n">initialize</span> <span class="ow">=</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="n">updateState</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">_msg</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="n">registeredTemplates</span> <span class="ow">=</span> <span class="kt">AllInDar</span>
  <span class="n">heartbeat</span> <span class="ow">=</span> <span class="kt">None</span>
  <span class="n">rule</span> <span class="ow">=</span> <span class="n">triggerRule</span>
</pre></div>
</div>
<p>In our rule, we first filter out all agreements and certificates issued by
us. Next, we iterate over all agreements. For each agreement we filter
the certificates by the owner of the agreement and finally upgrade the certificate
by exercising the <code class="docutils literal notranslate"><span class="pre">Upgrade</span></code> choice. We mark the certificate as pending
which temporarily removes it from the ACS and therefore stops the
trigger from trying to upgrade the same certificate multiple times if the
rule is triggered in quick succession.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">triggerRule</span> <span class="kt">:</span> <span class="kt">Party</span> <span class="ow">-&gt;</span> <span class="kt">TriggerA</span> <span class="nb">()</span> <span class="nb">()</span>
<span class="nf">triggerRule</span> <span class="n">issuer</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">agreements</span> <span class="ow">&lt;-</span>
    <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">_cid</span><span class="p">,</span> <span class="kr">agreement</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">agreement</span><span class="o">.</span><span class="n">issuer</span> <span class="o">==</span> <span class="n">issuer</span><span class="p">)</span> <span class="o">&lt;$&gt;</span>
    <span class="n">query</span> <span class="o">@</span><span class="kt">UpgradeCarbonCertAgreement</span>
  <span class="n">allCerts</span> <span class="ow">&lt;-</span>
    <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">_cid</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">cert</span><span class="o">.</span><span class="n">issuer</span> <span class="o">==</span> <span class="n">issuer</span><span class="p">)</span> <span class="o">&lt;$&gt;</span>
    <span class="n">query</span> <span class="o">@</span><span class="kt">CarbonCert</span>
  <span class="n">forA_</span> <span class="n">agreements</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">agreementCid</span><span class="p">,</span> <span class="kr">agreement</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">certsForOwner</span> <span class="ow">=</span> <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">_cid</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">cert</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="kr">agreement</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span> <span class="n">allCerts</span>
    <span class="n">forA_</span> <span class="n">certsForOwner</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">certCid</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
      <span class="n">emitCommands</span>
        <span class="p">[</span><span class="n">exerciseCmd</span> <span class="n">agreementCid</span> <span class="p">(</span><span class="kt">Upgrade</span> <span class="n">certCid</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">toAnyContractId</span> <span class="n">certCid</span><span class="p">]</span>
</pre></div>
</div>
<p>The trigger is a long-running process and the rule will be executed
whenever the state of the ledger changes. So whenever an owner accepts
an upgrade proposal, the trigger will run the rule and upgrade all
certificates of that owner.</p>
</div>
<div class="section" id="deploying-and-executing-the-upgrade">
<h2>Deploying and Executing the Upgrade<a class="headerlink" href="#deploying-and-executing-the-upgrade" title="Permalink to this headline">¶</a></h2>
<p>Now that we defined our Daml script and our trigger, it is time to use
them! If you still have Sandbox running from the previous section,
stop it to clear out all data before continuing.</p>
<p>First, we start sandbox passing in the <code class="docutils literal notranslate"><span class="pre">carbon-upgrade</span></code> DAR. Since a
DAR includes all transitive dependencies, this includes <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code>
and <code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-upgrade
$ daml sandbox .daml/dist/carbon-upgrade-1.0.0.dar
</pre></div>
</div>
<p>To simplify the setup here, we use a Daml script to create 3 parties
Alice, Bob and Charlie and two <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts issues by Alice, one
owned by Bob and one owned by Charlie.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">setup</span> <span class="kt">:</span> <span class="kt">Script</span> <span class="nb">()</span>
<span class="nf">setup</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">alice</span> <span class="ow">&lt;-</span> <span class="n">allocatePartyWithHint</span> <span class="s">&quot;Alice&quot;</span> <span class="p">(</span><span class="kt">PartyIdHint</span> <span class="s">&quot;Alice&quot;</span><span class="p">)</span>
  <span class="n">bob</span> <span class="ow">&lt;-</span> <span class="n">allocatePartyWithHint</span> <span class="s">&quot;Bob&quot;</span> <span class="p">(</span><span class="kt">PartyIdHint</span> <span class="s">&quot;Bob&quot;</span><span class="p">)</span>
  <span class="n">charlie</span> <span class="ow">&lt;-</span> <span class="n">allocatePartyWithHint</span> <span class="s">&quot;Charlie&quot;</span> <span class="p">(</span><span class="kt">PartyIdHint</span> <span class="s">&quot;Charlie&quot;</span><span class="p">)</span>
  <span class="n">bobProposal</span> <span class="ow">&lt;-</span> <span class="n">submit</span> <span class="n">alice</span> <span class="o">$</span> <span class="n">createCmd</span> <span class="p">(</span><span class="kt">CarbonCertProposal</span> <span class="n">alice</span> <span class="n">bob</span> <span class="mi">10</span><span class="p">)</span>
  <span class="n">submit</span> <span class="n">bob</span> <span class="o">$</span> <span class="n">exerciseCmd</span> <span class="n">bobProposal</span> <span class="kt">CarbonCertProposal_Accept</span>
  <span class="n">charlieProposal</span> <span class="ow">&lt;-</span> <span class="n">submit</span> <span class="n">alice</span> <span class="o">$</span> <span class="n">createCmd</span> <span class="p">(</span><span class="kt">CarbonCertProposal</span> <span class="n">alice</span> <span class="n">charlie</span> <span class="mi">5</span><span class="p">)</span>
  <span class="n">submit</span> <span class="n">charlie</span> <span class="o">$</span> <span class="n">exerciseCmd</span> <span class="n">charlieProposal</span> <span class="kt">CarbonCertProposal_Accept</span>
  <span class="n">pure</span> <span class="nb">()</span>
</pre></div>
</div>
<p>Run the script as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-initiate-upgrade
$ daml build
$ daml script --dar=.daml/dist/carbon-initiate-upgrade-1.0.0.dar --script-name=InitiateUpgrade:setup --ledger-host=localhost --ledger-port=6865 --wall-clock-time
</pre></div>
</div>
<p>If you now start Navigator from the <code class="docutils literal notranslate"><span class="pre">carbon-initiate-upgrade</span></code>
directory and log in as Alice, you can see the two <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts.</p>
<p>Next, we run the trigger for Alice. The trigger will keep running throughout the
rest of this example.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-upgrade-trigger
$ daml build
$ daml trigger --dar=.daml/dist/carbon-upgrade-trigger-1.0.0.dar --trigger-name=UpgradeTrigger:upgradeTrigger --ledger-host=localhost --ledger-port=6865 --ledger-party=Alice --wall-clock-time
</pre></div>
</div>
<p>With the trigger running, we can now run the script to create the
<code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> contracts (we could also have done that before
starting the trigger). The script takes an argument of type
<code class="docutils literal notranslate"><span class="pre">Party</span></code>. We can pass this in via the <code class="docutils literal notranslate"><span class="pre">--input-file</span></code> argument which
we will point to a file <code class="docutils literal notranslate"><span class="pre">party.json</span></code> containing <code class="docutils literal notranslate"><span class="pre">&quot;Alice&quot;</span></code>. This allows us to
change the party without having to change the code of the script.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-initiate-upgrade
$ daml build
$ daml script --dar=.daml/dist/carbon-initiate-upgrade-1.0.0.dar --script-name=InitiateUpgrade:initiateUpgrade --ledger-host=localhost --ledger-port=6865 --wall-clock-time --input-file=party.json
</pre></div>
</div>
<p>At this point, our trigger is running and the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code>
contracts for Bob and Charlie have been created. What is left to do is
to accept the proposals. Our trigger will then automatically pick them
up and upgrade the <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts.</p>
<p>First, start Navigator and log in as Bob. Click on the
<code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> and accept it. If you now go back to the
contracts tab, you can see that the <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contract has been
archived and instead there is a new <code class="docutils literal notranslate"><span class="pre">CarbonCertWithMethod</span></code> upgrade. Our
trigger has successfully upgraded the <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code>!</p>
<p>Next, log in as Charlie and accept the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code>. Just
like for Bob, you can see that the <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contract has been archived
and instead there is a new <code class="docutils literal notranslate"><span class="pre">CarbonCertWithMethod</span></code> contract.</p>
<p>Since we upgraded all <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts issued by Alice, we can now stop the
trigger and declare the update successful.</p>
</div>
</div>


              
            </div>
            
            
              <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upgrade.html" class="da-btn da-btn-label btn-prev" title="Upgrading Daml applications" accesskey="p" rel="prev">Previous</a>
      
      
        <a href="../app-dev/authorization.html" class="da-btn da-btn-label btn-next" title="Authorization" accesskey="n" rel="next">Next</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. Any unauthorized use, duplication or distribution is strictly prohibited. &#34;Digital Asset&#34; and &#34;Daml&#34; are Registered in the U.S. Patent and Trademark Office.

    </p>
  </div> 

</footer>
            
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->





  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


  
    
  
  <div id="inpageContent"></div>
  

</body>
</html>