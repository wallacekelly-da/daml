<!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Daml Triggers - Off-Ledger Automation in Daml &mdash; Daml SDK __VERSION__ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
  
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  <script type="text/javascript" src="../_static/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/copybutton.js"></script>
  
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Trigger Service" href="../tools/trigger-service/index.html" />
  <link rel="prev" title="Creating your own bindings" href="../app-dev/bindings-x-lang/index.html" /> 

  
  <link rel="icon" type="image/svg+xml"  href="../_static/images/daml-logo-mark-light.svg">
  <link rel="alternate icon" href="../_static/images/daml-favicon-1.ico">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MSWJMNX');</script>
  <!-- End Google Tag Manager -->

  
  <!-- Mopinion Pastea.se  start --><script type="text/javascript">(function(){var id="4s6vwov7ad6qyxhq8iwbyhocrsn2nm36k25";var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src","//deploy.mopinion.com/js/pastease.js");js.async=true;document.getElementsByTagName("head")[0].appendChild(js);var t=setInterval(function(){try{new Pastease.load(id);clearInterval(t)}catch(e){}},50)})();</script><!-- Mopinion Pastea.se end -->
</head>

<body class="wy-body-for-nav">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MSWJMNX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-nav-side-shadow"></div>
      <div class="wy-side-scroll">

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
          
          
          
          
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Daml Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installing the SDK</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/path-variables.html">Setting JAVA_HOME and PATH variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/manual-download.html">Manually installing the SDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Building Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/app-architecture.html">App Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-feature.html">Your First Feature</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.daml.com/cheat-sheet">Cheat Sheet</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../daml/intro/0_Intro.html">An introduction to Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/1_Token.html">1 Basic contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/2_DamlScript.html">2 Testing templates using Daml Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/3_Data.html">3 Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/4_Transformations.html">4 Transforming data using choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/5_Restrictions.html">5 Adding constraints to a contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/6_Parties.html">6 Parties and authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/7_Composing.html">7 Composing choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/8_Exceptions.html">8 Exception Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/9_Dependencies.html">9 Working with Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/10_Functional101.html">10 Functional Programming 101</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/11_StdLib.html">11 Intro to the Daml Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/12_Testing.html">12 Testing Daml Contracts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/reference/index.html">Language reference docs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/structure.html">Overview: template structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/templates.html">Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/choices.html">Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/updates.html">Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/data-types.html">Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/working-with.html">Built-in functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/expressions.html">Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/scenarios.html">Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/file-structure.html">File structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/packages.html">Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/contract-keys.html">Contract keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/patterns.html">Good design patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/initaccept.html">Initiate and Accept</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/multiparty-agreement.html">Multiple party agreement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/delegation.html">Delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/locking.html">Locking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-archiving.html">Locking by archiving</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-state.html">Locking by state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-safekeeping.html">Locking by safekeeping</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/legends.html">Diagram legends</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Building applications</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../app-dev/app-arch.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/bindings-ts/index.html">JavaScript Client Libraries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml2js.html">JavaScript Code Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-react.html">&#64;daml/react</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-ledger.html">&#64;daml/ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-types.html">&#64;daml/types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/testing.html">Testing Your Web App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../json-api/index.html">HTTP JSON API Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../json-api/lf-value-specification.html">Daml-LF JSON Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/search-query-language.html">Query language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/production-setup.html">Production Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-script/index.html">Daml Script</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-repl/index.html">Daml REPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade/index.html">Upgrading and Extending Daml applications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../upgrade/extend.html">Extending Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade/upgrade.html">Upgrading Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade/automation.html">Automating the Upgrade Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/authorization.html">Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/ledger-api.html">The Ledger API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/services.html">The Ledger API services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/index.html">gRPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/daml-to-ledger-api.html">How Daml types are translated to protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/daml-lf-translation.html">How Daml types are translated to Daml-LF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-java/index.html">Java bindings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/codegen.html">Generate Java code from Daml</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/example.html">Ping Pong Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/quickstart.html">Iou Quickstart Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-scala/index.html">Scala bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-js.html">Node.js bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-x-lang/index.html">Creating your own bindings</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Daml Triggers - Off-Ledger Automation in Daml</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/trigger-service/index.html">Trigger Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/auth0_example.html">Auth0 Example Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/auth-middleware/index.html">Auth Middleware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/auth-middleware/oauth2.html">OAuth 2.0 Auth Middleware</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../error-codes/self-service/index.html">Self-Service Error Codes (Experimental)</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../error-codes/self-service/index.html#self-service-error-codes-migration-guide">Self-Service Error Codes Migration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploying to Daml ledgers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploy/index.html">Overview of Daml ledgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/generic_ledger.html">Deploying to a generic Daml ledger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/ledger-topologies.html">Daml Ledger Topologies</a></li>
</ul>
<p class="caption"><span class="caption-text">Operating Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/index.html">Daml Participant pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/connect/index.html">Operating Daml Connect</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/helm.html">Connect Helm Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/auth0.html">Setting Up Auth0</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Developer Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/assistant.html">Daml Assistant (<code class="docutils literal notranslate"><span class="pre">daml</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/daml-studio.html">Daml Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sandbox.html">Daml Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/navigator/index.html">Navigator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/codegen.html">Daml codegen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler.html">Daml Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">Background concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/glossary.html">Glossary of concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/ledger-model/index.html">Daml Ledger Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-integrity.html">Integrity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-daml.html">Daml: Defining Contract Models Compactly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/identity-and-package-management.html">Identity and Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/time.html">Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/local-ledger.html">Causality and Local Ledgers</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://daml.com/examples">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Early Access Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/extractor.html">Extractor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/export/index.html">Ledger Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml-integration-kit/index.html">Daml Integration Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/ledger-api-test-tool/index.html">Ledger API Test Tool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/visual.html">Visualizing Daml Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/interoperability.html">Ledger Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/non-repudiation.html">Non-repudiation</a></li>
</ul>
<p class="caption"><span class="caption-text">Daml Ecosystem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support/overview.html">Daml Ecosystem Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/status-definitions.html">Status Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../support/component-statuses.html">Feature and Component Statuses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../support/releases.html">Releases and Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/compatibility.html">Portability, Compatibility, and Support Durations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/support.html">Getting Help</a></li>
</ul>

          
          
          
          <div class="pdf-download"><a href="../_downloads/DigitalAssetSDK.pdf" download>Download as PDF</a></div>
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <div class="topbar fixed">
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
          <i data-toggle="wy-nav-top" class="wy-nav-top-toggle"></i>
          
        </nav>
        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="navbar">
    <h1><img src="../_static/images/DAML_Logo_Blue.svg"></h1>
    <div class="navbar-menu">
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.daml.com/" role="menuitem" class="da-menu-link">Developers</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/products" role="menuitem" class="da-menu-link">Products</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com" role="menuitem" class="da-menu-link">Company</a>
        </div>
    </div>
</div>

        <div class="version ">
          <span class="hide-mobile">Version&nbsp;</span><span class="version_switcher_placeholder"></span>
          
        </div>


        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="search-inline">
    <div id="rtd-search-inline-form" class="wy-form">
        <input type="text" class="search-inline-input" placeholder="Search" name="q">
        <img src="../_static/images/Search.svg" class="search-inline-img"/>
    </div>
    <div class="search-alert">
        Please enter at least 3 letters.
    </div>
    <div id="search-inline-results" class="search-inline-results">
        
    </div>
</div>
          <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="content-menu collapsed">
    <span class="content-menu-title">In This Section</span>
    <span class="content-menu-expand"></span>
    <div class="content-menu-wrapper">
        
        <!-- Local TOC -->
        <div class="content-menu-toc"><ul>
<li><a class="reference internal" href="#">Daml Triggers - Off-Ledger Automation in Daml</a><ul>
<li><a class="reference internal" href="#how-to-think-about-triggers">How To Think About Triggers</a></li>
<li><a class="reference internal" href="#sample-trigger">Sample Trigger</a></li>
<li><a class="reference internal" href="#daml-trigger-basics">Daml Trigger Basics</a></li>
<li><a class="reference internal" href="#running-a-no-op-trigger">Running a No-Op Trigger</a></li>
<li><a class="reference internal" href="#diversion-updating-message">Diversion: Updating <code class="docutils literal notranslate"><span class="pre">Message</span></code></a></li>
<li><a class="reference internal" href="#autoreply">AutoReply</a></li>
<li><a class="reference internal" href="#command-deduplication">Command Deduplication</a></li>
<li><a class="reference internal" href="#authentication">Authentication</a></li>
<li><a class="reference internal" href="#when-not-to-use-daml-triggers">When not to use Daml triggers</a></li>
</ul>
</li>
</ul>
</div>
        
    </div>
</div>
        

      </div>
      <div class="wy-nav-content">
        
        <div class="rst-content">
          
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
                
  <div class="section" id="daml-triggers-off-ledger-automation-in-daml">
<h1>Daml Triggers - Off-Ledger Automation in Daml<a class="headerlink" href="#daml-triggers-off-ledger-automation-in-daml" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>In addition to the actual Daml logic which is uploaded to the Ledger
and the UI, Daml applications often need to automate certain
interactions with the ledger. This is commonly done in the form of a
ledger client that listens to the transaction stream of the ledger and
when certain conditions are met, e.g., when a template of a given type
has been created, the client sends commands to the ledger to
create a template of another type.</p>
<p>It is possible to write these clients in a language of your choice,
such as JavaScript, using the HTTP JSON API. However, that introduces an
additional layer of friction: you now need to translate between the
template and choice types in Daml and a representation of those Daml
types in the language you are using for your client. Daml triggers
address this problem by allowing you to write certain kinds of
automation directly in Daml, reusing all the Daml types and logic that
you have already defined. Note that, while the logic for Daml triggers
is written in Daml, they act like any other ledger client: they are
executed separately from the ledger, they do not need to be uploaded
to the ledger and they do not allow you to do anything that any other
ledger client could not do.</p>
<p>If you don’t want to follow along, but still want to get the final code
for this section to play with, you can get it by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">daml</span> <span class="n">new</span> <span class="o">--</span><span class="n">template</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">gsg</span><span class="o">-</span><span class="n">trigger</span> <span class="n">create</span><span class="o">-</span><span class="n">daml</span><span class="o">-</span><span class="n">app</span>
</pre></div>
</div>
<div class="section" id="how-to-think-about-triggers">
<h2>How To Think About Triggers<a class="headerlink" href="#how-to-think-about-triggers" title="Permalink to this headline">¶</a></h2>
<p>It is tempting to think of Daml Triggers as snippets of code that “react to
ledger events”. However, this is not the best way to think about them; while it
will work in some cases, in many corner cases that line of thought will lead to
subtle errors.</p>
<p>Instead, you should think of, and write, your triggers from the perspective of
“correcting the current ACS” to match some predefined expectations. Trigger
rules should be a combination of checking those expectations on the current ACS
and applyin corrective actions to bring back the ACS in line with its expected
state.</p>
<p>The “trigger” part is best thought of as an optimization: rather than check the
ACS constantly, we only apply our rules when something happens that we believe
_may_ lead to the state of the ledger diverging from our expectations.</p>
</div>
<div class="section" id="sample-trigger">
<h2>Sample Trigger<a class="headerlink" href="#sample-trigger" title="Permalink to this headline">¶</a></h2>
<p>Our example for this tutorial builds upon the Getting Started Guide,
specifically picking up right after the <a class="reference internal" href="../getting-started/first-feature.html"><span class="doc">Your First Feature</span></a>
section.</p>
<p>We assume that our requirements are to build a chatbot that reponds to every
message with:</p>
<blockquote>
<div>“Please, tell me more about that.”</div></blockquote>
<p>That should fool anyone and pass the Turing test, easily.</p>
<p>As explained above, while the layman description may be “responds to every
message”, our technical description is better phrased as “ensure that, at all
times, the last message we can see has been sent by us; if that is not the
case, the corrective action is to send a response to the last message we can
see”.</p>
</div>
<div class="section" id="daml-trigger-basics">
<h2>Daml Trigger Basics<a class="headerlink" href="#daml-trigger-basics" title="Permalink to this headline">¶</a></h2>
<p>A Daml trigger is a regular Daml project that you can build using <code class="docutils literal notranslate"><span class="pre">daml</span>
<span class="pre">build</span></code>. To get access to the API used to build a trigger, you need to add the
<code class="docutils literal notranslate"><span class="pre">daml-trigger</span></code> library to the <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> field in <code class="docutils literal notranslate"><span class="pre">daml.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dependencies</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-prim</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-stdlib</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-trigger</span>
</pre></div>
</div>
<p><strong>Note</strong>: In the specific case of the Getting Started Guide, this is already
included as part of the <code class="docutils literal notranslate"><span class="pre">create-daml-app</span></code> template.</p>
<p>In addition to that you also need to import the <code class="docutils literal notranslate"><span class="pre">Daml.Trigger</span></code>
module in your own code.</p>
<p>Daml triggers automatically track the active contract set (ACS), i.e., the set of contracts
that have been created and have not been archived, and the
commands in flight for you. In addition to that, they allow you to
have user-defined state that is updated based on new transactions and
command completions. For our chatbot trigger, the ACS is sufficient, so
we will simply use <code class="docutils literal notranslate"><span class="pre">()</span></code> as the type of the user defined state.</p>
<p>To create a trigger you need to define a value of type <code class="docutils literal notranslate"><span class="pre">Trigger</span> <span class="pre">s</span></code> where <code class="docutils literal notranslate"><span class="pre">s</span></code> is the type of your user-defined state:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">Trigger</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">Trigger</span>
  <span class="p">{</span> <span class="n">initialize</span> <span class="kt">:</span> <span class="kt">TriggerInitializeA</span> <span class="n">s</span>
  <span class="p">,</span> <span class="n">updateState</span> <span class="kt">:</span> <span class="kt">Message</span> <span class="ow">-&gt;</span> <span class="kt">TriggerUpdateA</span> <span class="n">s</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="n">rule</span> <span class="kt">:</span> <span class="kt">Party</span> <span class="ow">-&gt;</span> <span class="kt">TriggerA</span> <span class="n">s</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="n">registeredTemplates</span> <span class="kt">:</span> <span class="kt">RegisteredTemplates</span>
  <span class="p">,</span> <span class="n">heartbeat</span> <span class="kt">:</span> <span class="kt">Optional</span> <span class="kt">RelTime</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>To clarify, this is the definition in the <code class="docutils literal notranslate"><span class="pre">Daml.Trigger</span></code> library, reproduced
here for illustration purposes. This is not something you need to add to your
own code.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">initialize</span></code> function is called on startup and allows you to
initialize your user-defined state based on querying the active contract
set.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">updateState</span></code> function is called on new transactions and command
completions and can be used to update your user-defined state based on
the ACS and the transaction or completion. Since our Daml trigger does
not have any interesting user-defined state, we will not go into
details here.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rule</span></code> function is the core of a Daml trigger. It defines which
commands need to be sent to the ledger based on the party the trigger is
executed at, the current state of the ACS, and the user defined state.
The type <code class="docutils literal notranslate"><span class="pre">TriggerA</span></code> allows you to emit commands that are then sent to
the ledger, query the ACS with <code class="docutils literal notranslate"><span class="pre">query</span></code>, update the user-defined state,
as well as retrieve the commands in flight with <code class="docutils literal notranslate"><span class="pre">getCommandsInFlight</span></code>.
Like <code class="docutils literal notranslate"><span class="pre">Scenario</span></code> or <code class="docutils literal notranslate"><span class="pre">Update</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">do</span></code> notation and
<code class="docutils literal notranslate"><span class="pre">getTime</span></code> with <code class="docutils literal notranslate"><span class="pre">TriggerA</span></code>.</p>
<p>We can specify the templates that our trigger will operate
on. In our case, we will simply specify <code class="docutils literal notranslate"><span class="pre">AllInDar</span></code> which means that
the trigger will receive events for all template types defined in the
DAR. It is also possible to specify an explicit list of templates. For example,
to specify just the <code class="docutils literal notranslate"><span class="pre">Message</span></code> template, one would write:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nf">registeredTemplates</span> <span class="ow">=</span> <span class="kt">RegisteredTemplates</span> <span class="p">[</span><span class="n">registeredTemplate</span> <span class="o">@</span><span class="kt">Message</span><span class="p">],</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This is mainly useful for performance reasons if your DAR contains many templates that are not relevant for your trigger.
Note that providing an explicit list of templates also filters the result of querying the ACS using the Trigger API:
contracts of the excluded templates cannot be queried.</p>
<p>Finally, you can specify an optional heartbeat interval at which the trigger
will be sent a <code class="docutils literal notranslate"><span class="pre">MHeartbeat</span></code> message. This is useful if you want to ensure
that the trigger is executed at a certain rate to issue timed commands. We will
not be using heartbeats in this example.</p>
</div>
<div class="section" id="running-a-no-op-trigger">
<span id="id1"></span><h2>Running a No-Op Trigger<a class="headerlink" href="#running-a-no-op-trigger" title="Permalink to this headline">¶</a></h2>
<p>To implement a no-op trigger, one could write the following in a separate
<code class="docutils literal notranslate"><span class="pre">daml/ChatBot.daml</span></code> file:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nn">NoOp</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Daml.Trigger</span> <span class="k">as</span> <span class="n">T</span>

<span class="nf">noOp</span> <span class="kt">:</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Trigger</span> <span class="nb">()</span>
<span class="nf">noOp</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Trigger</span> <span class="kr">with</span>
  <span class="n">initialize</span> <span class="ow">=</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="n">updateState</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="n">rule</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
    <span class="n">debug</span> <span class="s">&quot;triggered&quot;</span>
    <span class="n">pure</span> <span class="nb">()</span>
  <span class="n">registeredTemplates</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="kt">AllInDar</span>
  <span class="n">heartbeat</span> <span class="ow">=</span> <span class="kt">None</span>
</pre></div>
</div>
<p>In the context of the Getting Started app, if you write the above file, then
run <code class="docutils literal notranslate"><span class="pre">daml</span> <span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">start</span></code> as usual, and then set up the trigger
with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>daml trigger --dar .daml/dist/create-daml-app-0.1.0.dar <span class="se">\</span>
             --trigger-name NoOp:noOp <span class="se">\</span>
             --ledger-host localhost <span class="se">\</span>
             --ledger-port <span class="m">6865</span> <span class="se">\</span>
             --ledger-party <span class="s2">&quot;bob&quot;</span>
</pre></div>
</div>
<p>and then play with the app as <code class="docutils literal notranslate"><span class="pre">alice</span></code> and <code class="docutils literal notranslate"><span class="pre">bob</span></code> just like you did for
<a class="reference internal" href="../getting-started/first-feature.html"><span class="doc">Your First Feature</span></a>, you should see the trigger command
printing a line for each interaction, containing the message <code class="docutils literal notranslate"><span class="pre">triggered</span></code> as
well as other debug information.</p>
</div>
<div class="section" id="diversion-updating-message">
<h2>Diversion: Updating <code class="docutils literal notranslate"><span class="pre">Message</span></code><a class="headerlink" href="#diversion-updating-message" title="Permalink to this headline">¶</a></h2>
<p>Before we can make our Trigger more useful, we need to think a bit more about
what it is supposed to do. For example, we don’t want to respond to <code class="docutils literal notranslate"><span class="pre">bob</span></code>’s
own messages. We also do not want to send messages when we have not received
any.</p>
<p>In order to start with something reasonably simple, we’re going to set the rule as</p>
<blockquote>
<div><em>if</em> the last message we can see was <em>not</em> sent by <code class="docutils literal notranslate"><span class="pre">bob</span></code>, <em>then</em> we’ll send
<code class="docutils literal notranslate"><span class="pre">&quot;Please,</span> <span class="pre">tell</span> <span class="pre">me</span> <span class="pre">more</span> <span class="pre">about</span> <span class="pre">that.&quot;</span></code> to whoever sent the last message we
can see.</div></blockquote>
<p>This raises the question of how we can determine which message is the last one,
given the current structure of a message. In order to solve that, we need to
add a <code class="docutils literal notranslate"><span class="pre">Time</span></code> field to <code class="docutils literal notranslate"><span class="pre">Message</span></code>, which can be done by editing the
<code class="docutils literal notranslate"><span class="pre">Message</span></code> template in <code class="docutils literal notranslate"><span class="pre">daml/User.daml</span></code> to look like:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">template</span> <span class="kt">Message</span> <span class="kr">with</span>
    <span class="n">sender</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">receiver</span><span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">content</span><span class="kt">:</span> <span class="kt">Text</span>
    <span class="n">receivedAt</span><span class="kt">:</span> <span class="kt">Time</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span>
</pre></div>
</div>
<p>This should result in Daml Studio reporting an error in the <code class="docutils literal notranslate"><span class="pre">SendMessage</span></code>
choice, as it now needs to set the <code class="docutils literal notranslate"><span class="pre">receivedAt</span></code> field. Here is the updated
code for <code class="docutils literal notranslate"><span class="pre">SendMessage</span></code>:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>    <span class="c1">-- New definition for SendMessage</span>
    <span class="kr">nonconsuming</span> <span class="n">choice</span> <span class="kt">SendMessage:</span> <span class="kt">ContractId</span> <span class="kt">Message</span> <span class="kr">with</span>
        <span class="n">sender</span><span class="kt">:</span> <span class="kt">Party</span>
        <span class="n">content</span><span class="kt">:</span> <span class="kt">Text</span>
      <span class="kr">controller</span> <span class="n">sender</span>
      <span class="kr">do</span>
        <span class="n">assertMsg</span> <span class="s">&quot;Designated user must follow you back to send a message&quot;</span> <span class="p">(</span><span class="n">elem</span> <span class="n">sender</span> <span class="n">following</span><span class="p">)</span>
        <span class="n">now</span> <span class="ow">&lt;-</span> <span class="n">getTime</span>
        <span class="n">create</span> <span class="kt">Message</span> <span class="kr">with</span> <span class="n">sender</span><span class="p">,</span> <span class="n">receiver</span> <span class="ow">=</span> <span class="n">username</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">receivedAt</span> <span class="ow">=</span> <span class="n">now</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">getTime</span></code> action (<a class="reference external" href="/daml/stdlib/Prelude.html#function-da-internal-lf-gettime-99334">doc</a>)
returns the time at which the command was received by the sandbox. In more
sensitive applications, this may not be sufficiently reliable, as transactions
may be processed in parallel (so “received at” timestamp order may not match
actual transaction order), and in distributed cases dishonest participants may
fudge this value. It’s good enough for this example, though.</p>
<p>Now that we have a field to sort on, and thus a way to identify the <em>latest</em>
message, we can turn our attention back to our trigger code.</p>
</div>
<div class="section" id="autoreply">
<h2>AutoReply<a class="headerlink" href="#autoreply" title="Permalink to this headline">¶</a></h2>
<p>Open up the trigger code again (<code class="docutils literal notranslate"><span class="pre">daml/ChatBot.daml</span></code>), and change it to:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nn">ChatBot</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Daml.Trigger</span> <span class="k">as</span> <span class="n">T</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">User</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">DA.List.Total</span> <span class="k">as</span> <span class="n">List</span>
<span class="kr">import</span> <span class="nn">DA.Action</span> <span class="p">(</span><span class="nf">when</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">DA.Optional</span> <span class="p">(</span><span class="nf">whenSome</span><span class="p">)</span>

<span class="nf">autoReply</span> <span class="kt">:</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Trigger</span> <span class="nb">()</span>
<span class="nf">autoReply</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Trigger</span>
  <span class="p">{</span> <span class="n">initialize</span> <span class="ow">=</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="n">updateState</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="n">rule</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">p</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
      <span class="n">message_contracts</span> <span class="ow">&lt;-</span> <span class="kt">T</span><span class="o">.</span><span class="n">query</span> <span class="o">@</span><span class="kt">User</span><span class="o">.</span><span class="kt">Message</span>
      <span class="kr">let</span> <span class="n">messages</span> <span class="ow">=</span> <span class="n">map</span> <span class="n">snd</span> <span class="n">message_contracts</span>
      <span class="n">debug</span> <span class="o">$</span> <span class="s">&quot;Messages so far: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="p">(</span><span class="n">length</span> <span class="n">messages</span><span class="p">)</span>
      <span class="kr">let</span> <span class="n">lastMessage</span> <span class="ow">=</span> <span class="kt">List</span><span class="o">.</span><span class="n">maximumOn</span> <span class="p">(</span><span class="o">.</span><span class="n">receivedAt</span><span class="p">)</span> <span class="n">messages</span>
      <span class="n">debug</span> <span class="o">$</span> <span class="s">&quot;Last message: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">lastMessage</span>
      <span class="n">whenSome</span> <span class="n">lastMessage</span> <span class="o">$</span> <span class="nf">\</span><span class="n">m</span> <span class="ow">-&gt;</span>
        <span class="n">when</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">receiver</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
          <span class="n">users</span> <span class="ow">&lt;-</span> <span class="kt">T</span><span class="o">.</span><span class="n">query</span> <span class="o">@</span><span class="kt">User</span><span class="o">.</span><span class="kt">User</span>
          <span class="n">debug</span> <span class="n">users</span>
          <span class="kr">let</span> <span class="n">isSender</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">\</span><span class="n">user</span> <span class="ow">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
          <span class="kr">let</span> <span class="n">replyTo</span> <span class="ow">=</span> <span class="kt">List</span><span class="o">.</span><span class="n">head</span> <span class="o">$</span> <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">isSender</span> <span class="n">user</span><span class="p">)</span> <span class="n">users</span>
          <span class="n">whenSome</span> <span class="n">replyTo</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="kt">T</span><span class="o">.</span><span class="n">dedupExercise</span> <span class="n">sender</span> <span class="p">(</span><span class="kt">User</span><span class="o">.</span><span class="kt">SendMessage</span> <span class="n">p</span> <span class="s">&quot;Please, tell me more about that.&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="n">registeredTemplates</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="kt">AllInDar</span>
  <span class="p">,</span> <span class="n">heartbeat</span> <span class="ow">=</span> <span class="kt">None</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Refresh <code class="docutils literal notranslate"><span class="pre">daml</span> <span class="pre">start</span></code> by pressing <code class="docutils literal notranslate"><span class="pre">r</span></code> (followed by <code class="docutils literal notranslate"><span class="pre">Enter</span></code> on Windows) in
its terminal, then start the trigger with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>daml trigger --dar .daml/dist/create-daml-app-0.1.0.dar <span class="se">\</span>
             --trigger-name ChatBot:autoReply <span class="se">\</span>
             --ledger-host localhost <span class="se">\</span>
             --ledger-port <span class="m">6865</span> <span class="se">\</span>
             --ledger-party <span class="s2">&quot;bob&quot;</span>
</pre></div>
</div>
<p>Play a bit with <code class="docutils literal notranslate"><span class="pre">alice</span></code> and <code class="docutils literal notranslate"><span class="pre">bob</span></code> in your browser, to get a feel for how
the trigger works. Watch both the messages in-browser and the debug statements
printed by the trigger runner.</p>
<p>Let’s walk through the <code class="docutils literal notranslate"><span class="pre">rule</span></code> code line-by-line:</p>
<ul class="simple">
<li>We use the <code class="docutils literal notranslate"><span class="pre">query</span></code> function to get all of the <code class="docutils literal notranslate"><span class="pre">Message</span></code> templates visible
to the current party (<code class="docutils literal notranslate"><span class="pre">p</span></code>; in our case this will be <code class="docutils literal notranslate"><span class="pre">bob</span></code>). Per the
<a class="reference external" href="/triggers/api/Daml-Trigger.html#function-daml-trigger-query-2759">documentation</a>,
this returns a list of tuples (contract id, payload), which we store as
<code class="docutils literal notranslate"><span class="pre">message_contracts</span></code>.</li>
<li>We then <a class="reference external" href="/daml/stdlib/Prelude.html#function-ghc-base-map-40302">map</a> the
<a class="reference external" href="/daml/stdlib/Prelude.html#function-da-internal-prelude-snd-86578">snd</a>
function on the result to get only the payloads, i.e. the actual data of the
messages we can see.</li>
<li>We print, as a <code class="docutils literal notranslate"><span class="pre">debug</span></code> message, the number of messages we can see.</li>
<li>On the next line, get the message with the highest <code class="docutils literal notranslate"><span class="pre">receivedAt</span></code> field
(<a class="reference external" href="/daml/stdlib/DA-List-Total.html#function-da-list-total-maximumon-67732">maximumOn</a>).</li>
<li>We then print another debug message, this time printing the message our code
has identified as “the last message visible to the current party”. If you run
this, you’ll see that <code class="docutils literal notranslate"><span class="pre">lastMessage</span></code> is actually a <code class="docutils literal notranslate"><span class="pre">Optional</span> <span class="pre">Message</span></code>. This
is because the <a class="reference external" href="/daml/stdlib/DA-List-Total.html#function-da-list-total-maximumon-67732">maximumOn</a>
function will return the element from a list for which the given functions
produces the highest value <em>if</em> the list has at least one element, but it
needs to still do something sensible if the list is empty; in this case, it
would return <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li>When <code class="docutils literal notranslate"><span class="pre">lastMessage</span></code> is <code class="docutils literal notranslate"><span class="pre">Some</span> <span class="pre">m</span></code>
(<a class="reference external" href="/daml/stdlib/DA-Optional.html#function-da-optional-whensome-23804">whenSome</a>),
we execute the given function.  Otherwise, <code class="docutils literal notranslate"><span class="pre">lastMessage</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code> and we
implicitly do nothing.</li>
<li>Next, we need to check whether the message has been sent <em>to</em> or <em>by</em> the
party running the trigger (with the current Daml model, it has to be one or
the other, as messages are only visible to the sender and receiver).
<a class="reference external" href="/daml/stdlib/DA-Action.html#function-da-action-when-53144">when</a> the
expression <code class="docutils literal notranslate"><span class="pre">m.receiver</span> <span class="pre">==</span> <span class="pre">p</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, we then our expectations of the
ledger state are wrong and we need to correct it. Otherwise, the state
matches our rule and we don’t need to do anything.</li>
<li>At this point we know the state is “wrong”, per our expectations, and start
engaging in correcting actions. For this trigger, this means sendinga message
to the sender of the last message. In order to do that, we need to find the
<code class="docutils literal notranslate"><span class="pre">User</span></code> contract for the sender. We start by getting the list of all
<code class="docutils literal notranslate"><span class="pre">User</span></code> contracts we know about, which will be all users who
follow the party running the trigger (and that party’s own <code class="docutils literal notranslate"><span class="pre">User</span></code>
contract). As for <code class="docutils literal notranslate"><span class="pre">Message</span></code> contracts earlier, the result of <code class="docutils literal notranslate"><span class="pre">query</span>
<span class="pre">&#64;User</span></code> is going to be a list of tuples with (contract id, payload). The big
difference is that this time we actually want to keep the contract ids, as
that is what we’ll use to send a message back.</li>
<li>We print the list of users we just fetched, as a debug message.</li>
<li>We create a function to identify the user we are looking for.</li>
<li>We get the user contract by applying our <code class="docutils literal notranslate"><span class="pre">isSender</span></code> function as a
<a class="reference external" href="/daml/stdlib/Prelude.html#function-da-internal-prelude-filter-27394">filter</a>
on the list of users, and then taking the
<a class="reference external" href="daml/stdlib/DA-List-Total.html#function-da-list-total-head-74336">head</a>
of that list, i.e. its first element.</li>
<li>Just like  <code class="docutils literal notranslate"><span class="pre">maximumOn</span></code>, <code class="docutils literal notranslate"><span class="pre">head</span></code> will return an <code class="docutils literal notranslate"><span class="pre">Optional</span> <span class="pre">a</span></code>, so the next
step is to check whether we have actually found the relevant <code class="docutils literal notranslate"><span class="pre">User</span></code>
contract. In most cases we should find it, but remember that users can send
us a message if <em>we</em> follow <em>them</em>, whereas we can only answer if <em>they</em>
follow <em>us</em>.</li>
<li>If we did find some <code class="docutils literal notranslate"><span class="pre">User</span></code> contract to reply to, we extract the
corresponding contract id (first element of the tuple, <code class="docutils literal notranslate"><span class="pre">sender</span></code>) and
discard the payload (second element, <code class="docutils literal notranslate"><span class="pre">_</span></code>), and we
<a class="reference external" href="triggers/api/Daml-Trigger.html#function-daml-trigger-dedupexercise-37617">exercise</a>
the <code class="docutils literal notranslate"><span class="pre">SendMessage</span></code> choice, passing in the current party <code class="docutils literal notranslate"><span class="pre">p</span></code> as the sender.
See below for additional information on what that <code class="docutils literal notranslate"><span class="pre">dedup</span></code> in the name of the
command means.</li>
</ul>
</div>
<div class="section" id="command-deduplication">
<h2>Command Deduplication<a class="headerlink" href="#command-deduplication" title="Permalink to this headline">¶</a></h2>
<p>Daml Triggers react to many things, and it’s usually important to make sure
that the same command is not sent mutiple times.</p>
<p>For example, in our <code class="docutils literal notranslate"><span class="pre">autoReply</span></code> chatbot above, the rule will be triggered not
only when we receive a message, but also when we send one, as well as when we
follow a user or get followed by a user, and when we stop following a user or a
user stops following us.</p>
<p>It’s easy to imagine a sequence of events that would make a naive trigger
implementation send too many messages. For example:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">alice</span></code> sends <code class="docutils literal notranslate"><span class="pre">&quot;hi&quot;</span></code>, so the trigger runs and sends an <code class="docutils literal notranslate"><span class="pre">exercise</span></code> command.</li>
<li>_Before_ the <code class="docutils literal notranslate"><span class="pre">exercise</span></code> command is fully processed, <code class="docutils literal notranslate"><span class="pre">carol</span></code> follows
<code class="docutils literal notranslate"><span class="pre">bob</span></code>, which triggers the rule again. The state of all the <code class="docutils literal notranslate"><span class="pre">Message</span></code>
contracts <code class="docutils literal notranslate"><span class="pre">bob</span></code> can see has not changed, so the rule might send the
response to <code class="docutils literal notranslate"><span class="pre">alice</span></code> again.</li>
</ul>
<p>We obviously don’t want that to happen, as it would likely prevent us from
passing that Turing test we were after.</p>
<p>Triggers offer a few features to help users manage that. Possibly the simplest
one is the <code class="docutils literal notranslate"><span class="pre">dedup*</span></code> family of ledger operations. When using those, the
trigger runner will keep track of the commands currently sent and prevent
sending the exact same command again. In the above example, the trigger would
see that, when <code class="docutils literal notranslate"><span class="pre">carol</span></code> follows <code class="docutils literal notranslate"><span class="pre">bob</span></code> and the rule runs <code class="docutils literal notranslate"><span class="pre">dedupExercise</span></code>,
there is already an Exercise command in flight with the exact same value, in
this case same message, same sender and same receiver.</p>
<p>Note that, if instead the in-between event is <code class="docutils literal notranslate"><span class="pre">alice</span></code> following <code class="docutils literal notranslate"><span class="pre">carol</span></code>,
this simple deduplication mechanism might not work as expected: because the
<code class="docutils literal notranslate"><span class="pre">User</span></code> contract ID for <code class="docutils literal notranslate"><span class="pre">alice</span></code> would have changed, the new command is not
the same as the in-flight one and thus a second <code class="docutils literal notranslate"><span class="pre">SendMessage</span></code> exercise would
be sent to the ledger.</p>
<p>Similarly, if <code class="docutils literal notranslate"><span class="pre">alice</span></code> sends a second message quickly after the first one,
this deduplication would prevent it, because the “response” does not have any
reference to which message it’s responding to. This may or may not be what we
want.</p>
<p>If this simple deduplication is not suited to your use-case, you have two other
tools at your disposal. The first one is the second argument to the
<code class="docutils literal notranslate"><span class="pre">emitCommands</span></code> action
(<a class="reference external" href="https://docs.daml.com/triggers/api/Daml-Trigger.html#function-daml-trigger-emitcommands-10563">doc</a>),
which is a list of contract IDs. These IDs will be filtered out of any ACS
<code class="docutils literal notranslate"><span class="pre">query</span></code> made by this trigger until the commands submitted as part of the same
<code class="docutils literal notranslate"><span class="pre">emitCommands</span></code> call have completed. If your trigger is based on seeing
certain contracts, this can be a simple, effective way to prevent triggering it
multiple times.</p>
<p>The last tool you have at your disposal is the <code class="docutils literal notranslate"><span class="pre">getCommandsInflight</span></code> action
(<a class="reference external" href="https://docs.daml.com/triggers/api/Daml-Trigger.html#function-daml-trigger-getcommandsinflight-32524">doc</a>),
which returns all of the commands this instance of the trigger runner has sent
and that have not yet been resolved (i.e. either committed or failed). You can
then build your own logic based on this list, the ACS, and possibly your own
trigger state.</p>
<p>Finally, do keep in mind that all of these mechanisms rely on internal state
from the trigger runner, which keeps track of which commands it has sent and
for which it’s not seen a completion. They will all fail to deduplicate if that
internal state is lost, e.g. if the trigger runner is shut down and a new one
is started. As such, these deduplication mechanisms should be seen as an
optimization rather than a requirement for correctness. The Daml model should
be designed such that duplicated commands are either rejected (e.g. using keys
or relying on changing contract IDs) or benign.</p>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>When using Daml triggers against a Ledger with authentication, you can
pass <code class="docutils literal notranslate"><span class="pre">--access-token-file</span> <span class="pre">token.jwt</span></code> to <code class="docutils literal notranslate"><span class="pre">daml</span> <span class="pre">trigger</span></code> which will
read the token from the file <code class="docutils literal notranslate"><span class="pre">token.jwt</span></code>.</p>
<p>If you plan to run more than one trigger at a time, or trigers for more than
one party at a time, you may be interested in the
<a class="reference internal" href="../tools/trigger-service/index.html"><span class="doc">Trigger Service</span></a>.</p>
</div>
<div class="section" id="when-not-to-use-daml-triggers">
<h2>When not to use Daml triggers<a class="headerlink" href="#when-not-to-use-daml-triggers" title="Permalink to this headline">¶</a></h2>
<p>Daml triggers deliberately only allow you to express automation that
listens for ledger events and reacts to them by sending commands to
the ledger.</p>
<p>Daml Triggers are not suited for automation that needs to interact
with services or data outside of the ledger. For those cases, you can
write a ledger client using the
<a class="reference internal" href="../app-dev/bindings-ts/index.html"><span class="doc">JavaScript bindings</span></a>
running against the HTTP JSON API or the
<a class="reference internal" href="../app-dev/bindings-java/index.html"><span class="doc">Java bindings</span></a> running against the
gRPC Ledger API.</p>
</div>
</div>


              
            </div>
            
            
              <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../app-dev/bindings-x-lang/index.html" class="da-btn da-btn-label btn-prev" title="Creating your own bindings" accesskey="p" rel="prev">Previous</a>
      
      
        <a href="../tools/trigger-service/index.html" class="da-btn da-btn-label btn-next" title="Trigger Service" accesskey="n" rel="next">Next</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. Any unauthorized use, duplication or distribution is strictly prohibited. &#34;Digital Asset&#34; and &#34;Daml&#34; are Registered in the U.S. Patent and Trademark Office.

    </p>
  </div> 

</footer>
            
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->





  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


  
    
  
  <div id="inpageContent"></div>
  

</body>
</html>